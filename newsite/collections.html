<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Mireia Artigas</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="styles/normalize.min.css">
        <link rel="stylesheet" href="styles/main.css">
        <script src="scripts/lib/modernizr-2.6.1-respond-1.1.0.min.js"></script>
    </head>
    <body class="collections">
        <!--[if lte IE 7]>
            <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
        <![endif]-->
        
        <div class="content">
            <!--<div id="canvas-markup" style="z-index:-1;position:absolute;background-color:hsla(120,100%,75%,0.3);left:30%;"></div>
            <div id="coord-info" style="z-index:1;position;position:absolute;background-color:hsla(190,90%,75%,0.4);width:263px;height:120px;color:white;">
                <fieldset>
                    <legend>Collage Settings:</legend>
                    <label>Buffer Threshold:<input id="bt" type="number" value="100" /></label>
                    <div style="font-size:1.2em;">
                        <label>x: <span id="coord-x"></span></label>
                        <label>y: <span id="coord-y"></span></label>
                    </div>
                </fieldset>
            </div>-->
        </div>
        
        <aside>
            <img src="images/decorations/logo2.png" class="logo" alt="Mireia Artigas"/>
            <nav>
                <ul>
                    <li class="current-menu-item"><a href="collections.html">Collections</a></li>
                    <li><a href="about.html">About us</a></li>
                    <li><a href="#" id="coord">Show coordinates on mouseover</a></li>
                    <li><a href="#">Contact us</a></li>
                </ul>
            </nav>
            <footer>&reg;2012 Mireia Artigas</footer>
        </aside>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="scripts/lib/jquery-1.8.2.min.js"><\/script>')</script>
        <script src="scripts/style.js"></script>
        <script>
            /** TODO: put this on some server
            function meta(conf) {
                this.src = conf.src;
                this.width = conf.width;
                this.height = conf.height;
            }
            function getImageMeta() {
                var metaData = [];
                $('.content img').each(function(i, el) {
                    metaData.push(new meta({ src: el.src.replace(/^.+(?=images\/)/, ''), width: el.naturalWidth, height: el.naturalHeight }));
                });
                return metaData;
            }
            console.log(
                JSON.stringify(
                    getImageMeta()
                )
            );*/
            var ns = ns || {};  // namespace
            ns.imagesMeta = [{"src":"images/mainfotos/col1.1.jpg","width":1701,"height":1134},{"src":"images/mainfotos/col2.1.jpg","width":1701,"height":1134},{"src":"images/mainfotos/col3.1.jpg","width":1626,"height":1125},{"src":"images/mainfotos/col5.1.jpg","width":1582,"height":1134},{"src":"images/mainfotos/col6.1.jpg","width":1701,"height":1134},{"src":"images/mainfotos/col4.1.jpg","width":850,"height":1276},{"src":"images/mainfotos/unik2.jpg","width":831,"height":1247},{"src":"images/mainfotos/col7.1.jpg","width":1304,"height":1134},{"src":"images/mainfotos/col8.1.jpg","width":1701,"height":978},{"src":"images/mainfotos/unik1.jpg","width":1469,"height":1128},{"src":"images/mainfotos/unik3.jpg","width":1701,"height":1134}];

            ns.multiply = function(a,b){ return a*b; };
            ns.imageArea = function(img1, img2) {
                return (Array.isArray(img1) ? img1.reduce(ns.multiply) : img1) + img2.reduce(ns.multiply);
            }
            ns.resizeToCanvas = function(img, i , all) {
                all[i][0] = img[0] * this.factor;
                all[i][1] = img[1] * this.factor;
            }
            ns.placeImage = function(img, i, all) {
                //TODO: implement genetic algorithme for best fit, e.g. randomize image order and calc cost
                ns.placeImage.go = ns.placeImage.go || true;
                // Calc width of elements compared to canvas width
                var width = 0, bufferThreshold = 110, len = all.length, padding = 20;
                if( !ns.placeImage.mod || i === ns.placeImage.mod && ns.placeImage.go) { // calc per row
                    for (var n = i; n < len; ++n) {                        
                        if( (width / this.area[0] * 100) < bufferThreshold ) {
                            width += all[n][0] + padding;
                            console.log(
                                "Image %s takes %spx of space - total: %spx",
                                (n-i)+1,
                                all[n][0].toFixed(2),
                                width.toFixed(2)
                            );
                        } else {
                            ns.placeImage.mod = n;                       
                            break;
                        }
                    }
                    if(n === len) {
                        ns.placeImage.go = false;
                        ns.placeImage.mod = len;
                    }   

                    firstImagePerRow.push(i);
                    //console.log("i = " + i,"mod = " + ns.placeImage.mod, "image = " + ns.urlTable[i]);
                    //var delta = (100 - width / this.area[0] * 100) / (n-i) / 100;
                    //var delta = (100 - width / this.area[0] * 100) / 100;
                    var delta = (this.area[0] - width) / (n-i);
                    for (var n = i; n < ns.placeImage.mod; ++n) {                        
                        console.log(
                            "Resizing width: %s from %s to %s",
                            ns.urlTable[n],
                            all[n][0].toFixed(2),
                            (all[n][0] + delta).toFixed(2)
                            //(all[n][0] + all[n][0] * delta).toFixed(2)
                        );
                        //all[n][0] = all[n][0] + all[n][0] * delta;                        
                        all[n][0] = Math.floor(all[n][0] + delta);
                    }                   
                }                
            }
            ns.createImages = function(images, urls) {
                images.forEach(function insertImage(img, i, all) {
                    /*
                    $('<img style="right:' + (i > 0 ? all[i-1][0] : 0) + 'px;" src="' + urls[i] + '" width="' + img[0] + 'px" height="' + img[1] + 'px"/>')*/
                    //$('<img src="' + urls[i] + '" width="' + img[0] + '" height="' + img[1] + '"/>')
                    //$('<img src="' + urls[i] + '" width="' + img[0] + '"/>')
                    $('<img src="http://src.sencha.io/' + img[0] + '/' + location.origin + '/newsite/' + urls[i] + '" width="' + img[0] + '"/>')
                        .appendTo(ns.canvas.scene);
                });                
            }
            ns.Canvas = function() {
                this.factor = 0.0;
                //this.currentSlot = 0;   // not used
                this.scene = $('.content');
                //this.area = [[0, 0, this.scene.width(), $(window).height(), 0]]; /* 0 === false */
                this.area = [this.scene.width()-17, $(window).height()];
            };
            ns.canvas = new ns.Canvas();
            // create all the image placeholders and an url-table
            ns.urlTable = new Array(ns.imagesMeta.length);
            /**
             * [width, height]
             */
            ns.imageRectangles = ns.imagesMeta.map(function(el, i) {
                var margin = 40;
                ns.urlTable[i] = el.src;    // update the urlTable
                return [el.width + margin, el.height + margin];
            });
            /*DEBUGGING*/
            var firstImagePerRow = [];
            console.log("canvas width: ", ns.canvas.scene.width()-17, "canvas height: ", $(window).height());
            //$('#canvas-markup').css({ height:$(window).height(), width:ns.canvas.scene.width()-17});

            // calculate how much space the images needs
            ns.canvas.factor =  Math.sqrt(
                                    ns.canvas.area.reduce(ns.multiply) /
                                    ns.imageRectangles.reduce(ns.imageArea)
                                );
            
            console.log("images = " + ns.imageRectangles.reduce(ns.imageArea) + "px\u00B2");

            // resize the images to fit in the canvas
            ns.imageRectangles.forEach(ns.resizeToCanvas, ns.canvas);
            // place images in canvas TODO: only applicable when the genetic algorithme is implemented
            ns.imageRectangles.forEach(ns.placeImage, ns.canvas);
            
            ns.createImages(ns.imageRectangles, ns.urlTable);
            //console.dir(ns.canvas);
            //console.dir(ns.imageRectangles);
            //console.dir(ns.urlTable);
            /*
            firstImagePerRow.forEach(function(imgIndex) {
                $('.content img').eq(imgIndex).css('backgroundColor', 'red');
            })
            */
            console.log(
                "factor = " + ns.canvas.factor,
                "canvas = " + ns.canvas.area.reduce(ns.multiply) + "px\u00B2",
                "images = " + ns.imageRectangles.reduce(ns.imageArea).toFixed(2) + "px\u00B2"
            );
            console.log("canvas width: ", ns.canvas.scene.width(), "canvas height: ", $(window).height());
            console.dir(ns.urlTable);

            function displayCoordinates(e) {
                displayCoordinates["coord-info"] = displayCoordinates["coord-info"] || $('#coord-info');
                displayCoordinates["coord-info"].find('#coord-x').html(e.clientX);
                displayCoordinates["coord-info"].find('#coord-y').html(e.clientY);
                displayCoordinates["coord-info"].css({left:e.pageX + 'px', top: e.pageY + 'px'});
                //console.dir(e);
            }

            $('#coord').one('click', function() {
                $('.content')
                    .css({cursor: 'crosshair'})
                    .on('mouseover', displayCoordinates)
                ;
            });

            ns.recalcCollage = function() {
                ns.imageRectangles.forEach(ns.placeImage, ns.canvas);
                ns.createImages(ns.imageRectangles, ns.urlTable);
            }    
            /*DEBUGGING
            var btValue = $('#bt');
            btValue.on('keyup', function(e) {

            });
            localStorage['bt'] = localStorage['bt'] || document.getElementById('bt').value;
            document.getElementById('bt').value = localStorage['bt'];
            */
        </script>
    </body>
</html>
